# 高度なドリフト補正機能

## 概要

移動平均フィルタと閾値ベースの更新を組み合わせた、高度なジャイロドリフト補正機能を実装しました。ブラウザから全てのパラメータを動的に調整できます。

## 機能説明

### 1. 移動平均フィルタ

**仕組み:**
1. ジャイロデータを時間方向でバッファリング
2. 指定されたウィンドウサイズ（サンプル数）で移動平均を計算
3. 移動平均値をドリフト成分として検出

**効果:**
- 長期的なドリフトを自動検出
- ノイズの影響を低減

### 2. 閾値ベースの更新

**仕組み:**
1. 現在のジャイロ値と移動平均の差を計算
2. 差が閾値以上の場合のみ移動平均を更新
3. 移動平均をジャイロ値から減算してドリフトをキャンセル

**効果:**
- 急激な動きを検出して移動平均を更新
- 静止時のドリフトのみをキャンセル

### 3. デッドゾーン処理

**仕組み:**
- ドリフト補正後のジャイロ値に対してデッドゾーンを適用
- 閾値以下の微小な値を0にする

**効果:**
- 残留ドリフトを完全に除去

## ブラウザUI設定

### 移動平均フィルタ (トグル)

**ON**: ドリフト補正を有効化  
**OFF**: ドリフト補正を無効化（従来のデッドゾーンのみ）

**推奨**: ON

### デッドゾーン閾値 (0.00 ~ 2.00 °/s)

微小な角速度を無視する閾値。

**小さい値 (0.2):**
- より敏感に反応
- ゆっくりした動きも検出
- ドリフトが増える可能性

**大きい値 (1.0):**
- ドリフトを強力に抑制
- ゆっくりした動きの検出が鈍くなる

**推奨**: 0.5 °/s（バランス）

### 移動平均ウィンドウ (5 ~ 50 サンプル)

移動平均の計算に使用するサンプル数。

**小さい値 (5):**
- 素早く変化に追従
- ノイズの影響を受けやすい
- ドリフト検出精度が低下

**大きい値 (50):**
- ノイズに強い
- ドリフト検出精度が向上
- 変化への追従が遅い

**推奨**: 20サンプル（100Hzで0.2秒分）

### 変化検出閾値 (0.10 ~ 2.00 °/s)

移動平均を更新する際の変化量の閾値。

**小さい値 (0.1):**
- 小さな動きでも移動平均を更新
- ドリフト補正が弱くなる可能性

**大きい値 (1.0):**
- 大きな動きのみで移動平均を更新
- ドリフト補正が強力
- 緩やかな動きが無視される可能性

**推奨**: 0.3 °/s

## アルゴリズムの流れ

```
1. ジャイロデータ取得
   ↓
2. [移動平均フィルタONの場合]
   - バッファに追加
   - 移動平均を計算
   - 現在値との差を計算
   ↓
3. [変化が閾値以上の場合]
   - 移動平均を更新
   ↓
4. ドリフトキャンセル
   - ジャイロ値 - 移動平均
   ↓
5. デッドゾーン適用
   - 閾値以下を0にする
   ↓
6. 角度積分
   - 角速度を時間積分
```

## 使用例

### ケース1: 静止時のドリフトを完全に除去したい

```
移動平均フィルタ: ON
デッドゾーン閾値: 0.8 °/s
移動平均ウィンドウ: 30サンプル
変化検出閾値: 0.5 °/s
```

### ケース2: 高感度で素早い動きを検出したい

```
移動平均フィルタ: ON
デッドゾーン閾値: 0.2 °/s
移動平均ウィンドウ: 10サンプル
変化検出閾値: 0.2 °/s
```

### ケース3: バランス重視（推奨設定）

```
移動平均フィルタ: ON
デッドゾーン閾値: 0.5 °/s
移動平均ウィンドウ: 20サンプル
変化検出閾値: 0.3 °/s
```

## トラブルシューティング

### ドリフトが完全に止まらない

**対策:**
1. デッドゾーン閾値を大きくする（0.8~1.0）
2. 変化検出閾値を大きくする（0.5~0.8）
3. 移動平均ウィンドウを大きくする（30~40）

### ゆっくりした動きが検出されない

**対策:**
1. デッドゾーン閾値を小さくする（0.2~0.3）
2. 変化検出閾値を小さくする（0.1~0.2）

### 動きが不自然（カクカクする）

**対策:**
1. 移動平均ウィンドウを小さくする（10~15）
2. 変化検出閾値を小さくする（0.2~0.3）

### ノイズが多い

**対策:**
1. 移動平均ウィンドウを大きくする（30~50）
2. デッドゾーン閾値を大きくする（0.6~0.8）

## 技術的な詳細

### 移動平均の計算

```javascript
const maX = gyroHistory.x.reduce((sum, val) => sum + val, 0) / gyroHistory.x.length;
```

### 変化検出

```javascript
const changeX = Math.abs(data.gyro.x - maX);
if (changeX > DRIFT_CHANGE_THRESHOLD) {
    gyroMovingAverage.x = maX;
}
```

### ドリフトキャンセル

```javascript
gyroX = data.gyro.x - gyroMovingAverage.x;
```

### デッドゾーン

```javascript
gyroX = Math.abs(gyroX) > GYRO_THRESHOLD ? gyroX : 0;
```

## まとめ

この高度なドリフト補正機能により、以下が実現できます：

✅ **自動ドリフト検出**: 移動平均でドリフト成分を自動検出  
✅ **適応的補正**: 閾値ベースで動きとドリフトを区別  
✅ **リアルタイム調整**: ブラウザから全パラメータを動的に変更  
✅ **柔軟な設定**: 用途に応じて最適な設定を選択可能  

デフォルト設定で多くの用途に対応できますが、特定の要件がある場合は上記のガイドラインを参考に調整してください。
