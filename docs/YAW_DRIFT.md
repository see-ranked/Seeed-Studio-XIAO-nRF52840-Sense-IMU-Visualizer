# Yawドリフト対策ガイド

## 問題の説明

Webビジュアライザーで、デバイスが静止しているのにYaw（ヨー）方向の角度が徐々にずれていく現象が発生します。これは**ジャイロドリフト**と呼ばれる正常な現象です。

## 原因

### 1. ジャイロスコープの特性
- **バイアス誤差**: センサーには微小なオフセットがあり、静止時でも完全に0にならない
- **積分誤差の蓄積**: 角速度を時間積分して角度を計算するため、小さな誤差が蓄積
- **温度ドリフト**: センサーの温度変化により誤差が変動

### 2. Yawが特にドリフトしやすい理由
- **Roll/Pitch**: 加速度計の重力方向データで補正可能
- **Yaw**: 重力方向では補正できない（磁気センサーが必要）

## 実装した対策

### 対策1: ジャイロデッドゾーン（閾値処理）

**実装内容**:
```javascript
const GYRO_THRESHOLD = 0.5; // °/s

// 微小な角速度を無視
const gyroX = Math.abs(data.gyro.x) > GYRO_THRESHOLD ? data.gyro.x : 0;
const gyroY = Math.abs(data.gyro.y) > GYRO_THRESHOLD ? data.gyro.y : 0;
const gyroZ = Math.abs(data.gyro.z) > GYRO_THRESHOLD ? data.gyro.z : 0;
```

**効果**:
- 静止時の微小な角速度（±0.5°/s以下）を無視
- ドリフトの蓄積速度を大幅に低減

**調整方法**:
`app.js`の`GYRO_THRESHOLD`値を変更:
- **小さくする（例: 0.2）**: より敏感に反応、ドリフトは増加
- **大きくする（例: 1.0）**: ドリフトは減少、動きの検出が鈍くなる

### 対策2: リセットボタン

**使用方法**:
1. Webビジュアライザーの**姿勢リセット**ボタンをクリック
2. Roll, Pitch, Yawが全て0°にリセットされる

**実装内容**:
```javascript
function resetOrientation() {
    roll = 0;
    pitch = 0;
    yaw = 0;
}
```

## 追加の対策案（未実装）

### 対策3: ジャイロバイアスキャリブレーション

起動時に静止状態でジャイロのバイアスを測定し、補正する方法。

**実装例**:
```javascript
// 起動時に100サンプル取得してバイアスを計算
let gyroBias = { x: 0, y: 0, z: 0 };

function calibrateGyro(samples) {
    // 平均値を計算
    gyroBias.x = samples.reduce((sum, s) => sum + s.x, 0) / samples.length;
    gyroBias.y = samples.reduce((sum, s) => sum + s.y, 0) / samples.length;
    gyroBias.z = samples.reduce((sum, s) => sum + s.z, 0) / samples.length;
}

// データ使用時にバイアスを減算
const gyroX = data.gyro.x - gyroBias.x;
```

### 対策4: 磁気センサー（コンパス）の追加

**ハードウェア要件**:
- LSM6DS3には磁気センサーが含まれていない
- 別途磁気センサー（例: LIS3MDL）を追加する必要がある

**効果**:
- Yaw方向を地磁気で補正可能
- ドリフトを完全に防止

### 対策5: カルマンフィルター

より高度なフィルタリング手法。

**メリット**:
- 相補フィルターより高精度
- ノイズとドリフトの両方を低減

**デメリット**:
- 実装が複雑
- 計算コストが高い

## 推奨設定

### 一般的な用途
```javascript
const GYRO_THRESHOLD = 0.5;  // バランスの取れた設定
```

### 高精度が必要な場合
```javascript
const GYRO_THRESHOLD = 0.2;  // より敏感
// ただし、定期的にリセットボタンを使用
```

### ドリフトを最小化したい場合
```javascript
const GYRO_THRESHOLD = 1.0;  // ドリフト最小
// ただし、ゆっくりした動きの検出が鈍くなる
```

## まとめ

| 対策 | 実装難易度 | 効果 | 備考 |
|------|----------|------|------|
| デッドゾーン | ★☆☆ | ★★☆ | 実装済み |
| リセットボタン | ★☆☆ | ★★★ | 実装済み |
| バイアスキャリブレーション | ★★☆ | ★★★ | 未実装 |
| 磁気センサー | ★★★ | ★★★★ | ハードウェア追加必要 |
| カルマンフィルター | ★★★ | ★★★★ | 未実装 |

現在の実装（デッドゾーン + リセットボタン）で、ほとんどの用途では十分な精度が得られます。
